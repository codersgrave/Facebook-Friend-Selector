/*!
 * Facebook Friend Selector
 * Copyright (c) 2012 Coders' Grave - http://codersgrave.com
 * Version: 1.2
 * Requires:
 *   jQuery v1.6.2 or above
 *   Facebook Integration - http://developers.facebook.com/docs/reference/javascript/
 */
(function(r,y,g,l){var j={},c=false,o=false,H=0,u=0,G=1,a="",A,s,C,b="http://developers.facebook.com/docs/reference/javascript/",B=function(){if(FB===l){alert("Facebook integration is not defined. View "+b);return false}j=g.extend(true,{},t,j);if(j.max>0&&j.max!==null){j.showSelectedCount=true;j.showButtonSelectAll=false}w();j.onStart()},d=function(){s.fadeOut(400,function(){A.empty();s.remove();z();C.fadeOut(400,function(){C.remove()})});c=false;o=false;j.onClose()},F=function(){var I=[];g("input.fs-friends:checked").each(function(){var L=g(this).val().split("-");var M=L[1];I.push(parseInt(M,10))});if(j.facebookInvite===true){var K="";for(var J=0;J<I.length;J++){K+=I[J]+","}K=K.substr(0,K.length-1);FB.ui({method:"apprequests",message:j.lang.facebookInviteMessage,to:K},function(L){if(L!==null){j.onSubmit(I);if(j.closeOnSubmit===true){d()}}})}else{j.onSubmit(I);if(j.closeOnSubmit===true){d()}}},w=function(){if(c===true){return}c=true;g("body").append(C=g('<div id="fs-overlay"></div>'),s=g('<div id="fs-dialog-box-wrap"></div>'));s.append('<div class="fs-dialog-box-bg" id="fs-dialog-box-bg-n"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-ne"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-e"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-se"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-s"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-sw"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-w"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-nw"></div>');s.append(A=g('<div id="fs-dialog-box-content"></div>'));var I='<div id="fs-dialog" class="fs-color-'+j.color+'"><h2 id="fs-dialog-title"><span>'+j.lang.title+'</span></h2><div id="fs-filter-box"><div id="fs-input-wrap"><input type="text" id="fs-input-text" title="'+j.lang.searchText+'" /><a href="javascript:{}" id="fs-reset">Reset</a></div></div><div id="fs-user-list"><ul></ul></div><div id="fs-filters-buttons"><div id="fs-filters"><a href="javascript:{}" id="fs-show-selected"><span>'+j.lang.buttonShowSelected+'</span></a></div><div id="fs-dialog-buttons"><a href="javascript:{}" id="fs-submit-button" class="fs-button"><span>'+j.lang.buttonSubmit+'</span></a><a href="javascript:{}" id="fs-cancel-button" class="fs-button"><span>'+j.lang.buttonCancel+"</span></a></div></div></div>";A.html(I);n();m(true);i();k();g(r).resize(function(){m(false)})},n=function(){g("#fs-user-list").append('<div id="fs-loading"></div>');FB.api("/me/friends",function(K){if(K.error){alert(j.lang.fbConnectError);d();return false}var J=K.data;var N=j.maxFriendsCount!==null&&j.maxFriendsCount>0;if(j.showRandom===true||N===true){J=D(K.data)}for(var M=0,I=0;M<J.length;M++){if(N&&j.maxFriendsCount<=I){break}if(g.inArray(parseInt(J[M].id,10),j.getStoredFriends)>=0){E(M,J,true);I++}}for(var L=0;L<J.length;L++){if(N&&j.maxFriendsCount<=L+j.getStoredFriends.length){break}if(g.inArray(parseInt(J[L].id,10),j.excludeIds)>=0){continue}if(g.inArray(parseInt(J[L].id,10),j.getStoredFriends)<=-1){E(L,J,false)}}g("#fs-loading").remove()})},E=function(J,I,M){var L=g("<li/>");var K='<a class="fs-anchor" href="javascript://"><input class="fs-fullname" type="hidden" name="fullname[]" value="'+I[J].name.toLowerCase().replace(/\s/gi,"+")+'" /><input class="fs-friends" type="checkbox" name="friend[]" value="fs-'+I[J].id+'" /><img class="fs-thumb" src="https://graph.facebook.com/'+I[J].id+'/picture" /><span class="fs-name">'+f(I[J].name,15)+"</span></a>";L.append(K);g("#fs-user-list ul").append(L);if(M){h(L)}},i=function(){s.delegate("#fs-cancel-button","click.fs",function(){d()});s.delegate("#fs-submit-button","click.fs",function(){F()});g("#fs-dialog input").focus(function(){if(g(this).val()===g(this)[0].title){g(this).val("")}}).blur(function(){if(g(this).val()===""){g(this).val(g(this)[0].title)}}).blur();g("#fs-dialog input").keyup(function(){e(g(this))});s.delegate("#fs-reset","click.fs",function(){g("#fs-input-text").val("");e(g("#fs-dialog input"));g("#fs-input-text").blur()});s.delegate("#fs-user-list li","click.fs",function(){h(g(this))});g("#fs-show-selected").click(function(){p(g(this))});g(y).keyup(function(I){if(I.which===27&&j.enableEscapeButton===true){d()}});if(j.closeOverlayClick===true){C.css({cursor:"pointer"});C.bind("click.fs",d)}},h=function(K){var J=K;if(J.hasClass("checked")){J.removeClass("checked");J.find("input.fs-friends").attr("checked",false);G--;if(G-1!==g("#fs-user-list li").length){g("#fs-select-all").text(j.lang.buttonSelectAll)}}else{var I=q();if(I===false){return false}G++;J.addClass("checked");J.find("input.fs-friends").attr("checked",true)}x()},z=function(){g("#fs-reset").undelegate("click.fs");g("#fs-user-list li").undelegate("click.fs");G=1;g("#fs-select-all").undelegate("click.fs")},f=function(K,I){var J=K.length;if(J<=I){return K}return K.substr(0,I)+"..."},e=function(K){var L=g("#fs-dialog");a=g.trim(K.val());var J=a.toLowerCase().replace(/\s/gi,"+");var M=g("#fs-user-list .fs-fullname[value*="+J+"]");var I=g("#fs-user-list ul");I.children().hide();g.each(M,function(){g(this).parents("li").show()});var N="";if(M.length>0&&a>""){N=j.lang.summaryBoxResult.replace("{0}",'"'+K.val()+'"');N=N.replace("{1}",M.length)}else{N=j.lang.summaryBoxNoResult.replace("{0}",'"'+K.val()+'"')}if(!L.has("#fs-summary-box").length){g("#fs-filter-box").after('<div id="fs-summary-box"><span id="fs-result-text">'+N+"</span></div>")}else{if(!L.has("#fs-result-text").length){g("#fs-summary-box").prepend('<span id="fs-result-text">'+N+"</span>")}else{g("#fs-result-text").text(N)}}if(a===""){if(L.has("#fs-summary-box").length){if(G===1){g("#fs-summary-box").remove()}else{g("#fs-result-text").remove()}}}},m=function(M){H=g(r).width();u=g(r).height();var L=g(y).height(),N=s.width(),J=s.height(),K=(H/2)-(N/2),I=(u/2)-(J/2);if(M===true){C.css({"background-color":j.overlayColor,opacity:j.overlayOpacity,height:L}).fadeIn("fast",function(){s.css({left:K,top:I}).fadeIn()})}else{s.stop().animate({left:K,top:I},200);C.css({height:L})}},D=function(L){for(var J,I,K=L.length;K;J=parseInt(Math.random()*K,10),I=L[--K],L[K]=L[J],L[J]=I){}return L},q=function(){if(G>j.max&&j.max!==null){var I=j.lang.selectedLimitResult.replace("{0}",j.max);g(".fs-limit").html('<span class="fs-limit fs-full">'+I+"</span>");return false}},x=function(){if(G>1&&j.showSelectedCount===true){var I=j.lang.selectedCountResult.replace("{0}",(G-1));if(!g("#fs-dialog").has("#fs-summary-box").length){g("#fs-filter-box").after('<div id="fs-summary-box"><span class="fs-limit fs-count">'+I+"</span></div>")}else{if(!g("#fs-dialog").has(".fs-limit.fs-count").length){g("#fs-summary-box").append('<span class="fs-limit fs-count">'+I+"</span>")}else{g(".fs-limit").text(I)}}}else{if(a===""){g("#fs-summary-box").remove()}else{g(".fs-limit").remove()}}},v=function(){g("#fs-user-list li").removeClass("checked");g("#fs-user-list input.fs-friends").attr("checked",false);G=1},k=function(){if(j.showButtonSelectAll===true&&j.max===null){g("#fs-show-selected").before('<a href="javascript:{}" id="fs-select-all"><span>'+j.lang.buttonSelectAll+"</span></a> - ");s.delegate("#fs-select-all","click.fs",function(){if(G-1!==g("#fs-user-list li").length){g("#fs-user-list li:hidden").show();v();g("#fs-user-list li").each(function(){h(g(this))});g("#fs-select-all").text(j.lang.buttonDeselectAll);if(o===true){o=false;g("#fs-show-selected").text(j.lang.buttonShowSelected)}}else{v();x();g("#fs-select-all").text(j.lang.buttonSelectAll)}})}},p=function(J){var I=g("#fs-user-list ul"),K=I.find("li"),L=I.find("li.checked");if(L.length!==0&&L.length!==K.length||o===true){if(o===true){J.removeClass("active").text(j.lang.buttonShowSelected);I.children().show();o=false}else{J.addClass("active").text(j.lang.buttonShowAll);I.children().hide();g.each(L,function(){g(this).show()});o=true}}},t={max:null,excludeIds:[],getStoredFriends:[],closeOverlayClick:true,enableEscapeButton:true,overlayOpacity:"0.3",overlayColor:"#000",closeOnSubmit:false,showSelectedCount:true,showButtonSelectAll:true,color:"default",lang:{title:"Friend Selector",buttonSubmit:"Send",buttonCancel:"Cancel",buttonSelectAll:"Select All",buttonDeselectAll:"Deselect All",buttonShowSelected:"Show Selected",buttonShowAll:"Show All",summaryBoxResult:"{1} best results for {0}",summaryBoxNoResult:"No results for {0}",searchText:"Enter a friend's name",fbConnectError:"You must connect to Facebook to see this.",selectedCountResult:"You have choosen {0} people.",selectedLimitResult:"Limit is {0} people.",facebookInviteMessage:"Invite message"},maxFriendsCount:null,showRandom:false,facebookInvite:false,onStart:function(I){return null},onClose:function(I){return null},onSubmit:function(I){return null}};g.fn.fSelector=function(I){this.unbind("click.fs");this.bind("click.fs",function(){j=I;B()});return this}})(window,document,jQuery);